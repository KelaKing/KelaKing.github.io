<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Queue ä¸ Thread åŒºåˆ« | Gridea</title>
<link rel="shortcut icon" href="https://kelaking.github.io/favicon.ico?v=1594109776579">
<link href="https://cdn.jsdelivr.net/npm/remixicon@2.3.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://kelaking.github.io/styles/main.css">
<link rel="alternate" type="application/atom+xml" title="Queue ä¸ Thread åŒºåˆ« | Gridea - Atom Feed" href="https://kelaking.github.io/atom.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">



    <meta name="description" content="SDWebImageæºç åˆ†æå‘ç°
SDWebImageCompat.h ä¸­å®šä¹‰äº† dispatch_main_async_safe è¿™ä¹ˆä¸€æ®µå®ï¼Œhistory ä¸­æœ‰è¿™ä¹ˆä¸ª commit
#define dispatch_main_async..." />
    <meta name="keywords" content="iOS" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
    <script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
  </head>
  <body>
    <div class="main">
      <div class="main-content">
        <div class="site-header">
  <a href="https://kelaking.github.io">
  <img class="avatar" src="https://kelaking.github.io/images/avatar.png?v=1594109776579" alt="">
  </a>
  <h1 class="site-title">
    Gridea
  </h1>
  <p class="site-description">
    æ¸©æ•…è€ŒçŸ¥æ–°
  </p>
  <div class="menu-container">
    
      
        <a href="/" class="menu">
          é¦–é¡µ
        </a>
      
    
      
        <a href="/archives" class="menu">
          å½’æ¡£
        </a>
      
    
      
        <a href="/tags" class="menu">
          æ ‡ç­¾
        </a>
      
    
      
        <a href="/post/about" class="menu">
          å…³äº
        </a>
      
    
  </div>
  <div class="social-container">
    
      
    
      
    
      
    
      
    
      
    
  </div>
</div>

        <div class="post-detail">
          <article class="post">
            <h2 class="post-title">
              Queue ä¸ Thread åŒºåˆ«
            </h2>
            <div class="post-info">
              <span>
                2017-03-09
              </span>
              <span>
                3 min read
              </span>
              
                <a href="https://kelaking.github.io/tag/3B2mf5zro/" class="post-tag">
                  # iOS
                </a>
              
            </div>
            
            <div class="post-content-wrapper">
              <div class="post-content">
                <h1 id="sdwebimageæºç åˆ†æå‘ç°">SDWebImageæºç åˆ†æå‘ç°</h1>
<p><a href="https://github.com/SDWebImage/SDWebImage/blob/master/SDWebImage/Core/SDWebImageCompat.h">SDWebImageCompat.h</a> ä¸­å®šä¹‰äº† <code>dispatch_main_async_safe</code> è¿™ä¹ˆä¸€æ®µå®ï¼Œhistory ä¸­æœ‰è¿™ä¹ˆä¸ª commit</p>
<pre><code class="language-diff">#define dispatch_main_async_safe(block)\
-    if ([NSThread isMainThread]) {\
+    if (strcmp(dispatch_queue_get_label(DISPATCH_CURRENT_QUEUE_LABEL), dispatch_queue_get_label(dispatch_get_main_queue())) == 0) {\
    block();\
} else {\
    dispatch_async(dispatch_get_main_queue(), block);\
}
</code></pre>
<p><code>dispatch_main_async_safe</code> ä½œç”¨æ˜¯æ‰§è¡Œä¸€ä¸ª blockï¼Œå¦‚æœå½“å‰æ˜¯ä¸»çº¿ç¨‹åˆ™ç›´æ¥æ‰§è¡Œï¼Œå¦åˆ™åˆ‡åˆ°ä¸»é˜Ÿåˆ—ä¸­æ‰§è¡Œã€‚é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œä¸ºä»€ä¹ˆ <code>[NSThread isMainThread]</code> ä¸èƒ½ç”¨æ¥åˆ¤æ–­æ˜¯å¦æ˜¯ä¸»çº¿ç¨‹å‘¢ï¼Ÿ<br>
å…ˆçœ‹ä¸‹é¢ä¸€æ®µä»£ç ï¼š</p>
<pre><code class="language-objc">dispatch_queue_t queue = dispatch_queue_create(&quot;KelaKing&quot;, DISPATCH_QUEUE_SERIAL);
dispatch_sync(queue, ^{
  if ([NSThread isMainThread]) {
    NSLog(@&quot;Main thread&quot;);
  } else {
    NSLog(@&quot;Background thread&quot;);
  }
});
</code></pre>
<p>è¿™æ®µä»£ç åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œç»“æœè¾“å‡º <code>Main thread</code>. å¦‚æœæ”¾åœ¨å­çº¿ç¨‹ä¸­æ‰§è¡Œè¿™æ®µä»£ç ä¼šè¾“å‡º <code>Background thread</code>. çœ‹æ¥ block åœ¨å“ªæ‰§è¡Œå’Œ queue æ²¡å…³ç³»ï¼Ÿæˆ‘ä»¬æŸ¥é˜… dispatch_sync å®˜æ–¹æ–‡æ¡£å‘ç°æœ€åä¸€æ®µè¯´æ˜äº†è¿™ä¸ªé—®é¢˜ï¼š</p>
<blockquote>
<p>As an optimization, this function invokes the block on the current thread when possible.</p>
</blockquote>
<p>å¤§æ¦‚æ„æ€æ˜¯ block åœ¨å“ªä¸ªçº¿ç¨‹æ‰§è¡Œè¦çœ‹ dispatch_sync å®ƒçš„å¿ƒæƒ…ğŸ˜<br>
é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼š</p>
<ol>
<li>åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œè€Œä¸æ˜¯å­çº¿ç¨‹æ‰§è¡Œæœ‰ä»€ä¹ˆå¥½å¤„å—ï¼Ÿ</li>
<li>åœ¨ä¸»çº¿ç¨‹ä¸­åŒæ­¥åˆ°ä¸»çº¿ç¨‹æ‰§è¡Œä¸ä¼šæ­»é”å—ï¼Ÿ</li>
</ol>
<h1 id="queue-thread">Queue â‰  Thread</h1>
<p><code>Dispatch</code> å®˜æ–¹æ–‡æ¡£æœ‰ä¸€æ®µæè¿°ï¼š</p>
<blockquote>
<p>Work submitted to dispatch queues are executed on a pool of threads fully managed by the system. No guarantee is made as to the thread on which a task executes.</p>
</blockquote>
<p>å¤§æ¦‚æ„æ€æ˜¯é˜Ÿåˆ—åœ¨æ‰§è¡Œä¸å¯æè¿°ä»»åŠ¡æ—¶éœ€è¦ä¸€ä¸ªçº¿ç¨‹ï¼Œä»ç³»ç»Ÿç®¡ç†çš„çº¿ç¨‹æ± ä¸­é€‰å“ªä¸ªå¹¶ä¸é‡è¦ï¼Œåæ­£å…³äº†ç¯éƒ½ä¸€æ ·ğŸ˜<br>
è¿™ä¹ˆçœ‹æ¥é˜Ÿåˆ—å’Œçº¿ç¨‹å¹¶ä¸å¯¹åº”ï¼Œcommit ä¸­ä¹Ÿå‚ç…§äº†<a href="http://blog.benjamin-encz.de/post/main-queue-vs-main-thread/">GCD's Main Queue vs. Main Thread</a>. å› ä¸ºæœ‰äº› API ä¸ä»…è¦æ±‚æ‰§è¡Œåœ¨ä¸»çº¿ç¨‹ä¸­ï¼Œè¿˜éœ€è¦åœ¨ä¸»é˜Ÿåˆ—ä¸­ã€‚æ‰€ä»¥ SDWebImage åšå‡ºæ­¤ä¿®æ”¹æ¥å¢åŠ å¥å£®æ€§ã€‚dispatch_sync ä¼šé˜»å¡å½“å‰é˜Ÿåˆ—ï¼Œå¹¶ä¸æ˜¯é˜»å¡å½“å‰çº¿ç¨‹ï¼Œæ‰€ä»¥æ²¡æœ‰æ­»é”ã€‚<br>
GCD è¯´äº†å¯èƒ½åœ¨å½“å‰çº¿ç¨‹è°ƒç”¨æ˜¯ä¼˜åŒ–é‚£è‚¯å®šæ˜¯æœ‰å¥½å¤„çš„ï¼šå› ä¸ºç³»ç»Ÿåˆ‡æ¢çº¿ç¨‹æ˜¯ä¼šæœ‰æ€§èƒ½æŸè€—çš„ï¼ŒGCD å‘ç°æ˜¯åŒæ­¥æ‰§è¡Œä¼šç›´æ¥å°† block æ‰”åˆ°å½“å‰çº¿ç¨‹æ‰§è¡Œã€‚ä½ é—®æˆ‘ä¸ºä»€ä¹ˆçŸ¥é“ GCD è¿™ä¹ˆå¹²ï¼Ÿå› ä¸ºæˆ‘æ˜¯çŒœçš„â€¦â€¦æºç ä¸Šä¸‡è¡Œå“å¾—æˆ‘ç›´æ¥åˆ äº†ã€‚</p>
<h1 id="dispatch_sync-å¼•å‘çš„çº¿ç¨‹å®‰å…¨æ€è€ƒ">dispatch_sync å¼•å‘çš„çº¿ç¨‹å®‰å…¨æ€è€ƒ</h1>
<p>å…¶å®é™¤äº† <code>dispatch_main_async_safe</code> å®ä¹‹å‰è¿˜æœ‰ <code>dispatch_main_sync_safe</code>. åˆ é™¤è¯¥å®æ˜¯å› ä¸ºæœ‰å¯èƒ½ä¼šå‘ç”Ÿæ­»é”ã€‚<a href="https://www.raywenderlich.com/5370-grand-central-dispatch-tutorial-for-swift-4-part-1-2">æ·±å…¥ç†è§£ GCD</a> ä¹Ÿæåˆ°ä¸å»ºè®®åœ¨ä¸²è¡Œé˜Ÿåˆ—ä¸­ä½¿ç”¨ dispatch_sync.</p>

              </div>
              <div class="toc-container">
                <ul class="markdownIt-TOC">
<li><a href="#sdwebimage%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%8F%91%E7%8E%B0">SDWebImageæºç åˆ†æå‘ç°</a></li>
<li><a href="#queue-thread">Queue â‰  Thread</a></li>
<li><a href="#dispatch_sync-%E5%BC%95%E5%8F%91%E7%9A%84%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E6%80%9D%E8%80%83">dispatch_sync å¼•å‘çš„çº¿ç¨‹å®‰å…¨æ€è€ƒ</a></li>
</ul>

              </div>
            </div>
          </article>
        </div>

        

        

        <div class="site-footer">
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
  <a class="rss" href="https://kelaking.github.io/atom.xml" target="_blank">
    <i class="ri-rss-line"></i> RSS
  </a>
</div>

      </div>
    </div>

    <script>
      hljs.initHighlightingOnLoad()

      let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

      // This should probably be throttled.
      // Especially because it triggers during smooth scrolling.
      // https://lodash.com/docs/4.17.10#throttle
      // You could do like...
      // window.addEventListener("scroll", () => {
      //    _.throttle(doThatStuff, 100);
      // });
      // Only not doing it here to keep this Pen dependency-free.

      window.addEventListener("scroll", event => {
        let fromTop = window.scrollY;

        mainNavLinks.forEach((link, index) => {
          let section = document.getElementById(decodeURI(link.hash).substring(1));
          let nextSection = null
          if (mainNavLinks[index + 1]) {
            nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
          }
          if (section.offsetTop <= fromTop) {
            if (nextSection) {
              if (nextSection.offsetTop > fromTop) {
                link.classList.add("current");
              } else {
                link.classList.remove("current");    
              }
            } else {
              link.classList.add("current");
            }
          } else {
            link.classList.remove("current");
          }
        });
      });

    </script>
  </body>
</html>
